<div class="dashboard-container">
  <!-- Top Header Strip -->
  <div class="top-header">
    <span class="menu-icon" (click)="toggleMenu()">‚ò∞</span>

    <div class="header-right">
      <button class="btn-back" [routerLink]="['/dashboard', id]">‚Üê Back</button>
      <img class="profile-pic" [src]="userProfilePic" alt="User Profile" />
    </div>
  </div>

  <!-- Sliding Side Menu -->
  <nav class="side-menu" [class.open]="menuOpen">
    <div class="close-btn" (click)="toggleMenu()">√ó</div>
    <ul>
      <li><a [routerLink]="['/dashboard', id]">Dashboard</a></li>
      <li><a [routerLink]="['/weather', id]">Weather</a></li>
      <li><a [routerLink]="['/land-list', id]">Farm Sections</a></li>
      <li><a [routerLink]="['/ask-ai']">Ask AI</a></li>
      <li><a href="#">Reports</a></li>
      <li><a [routerLink]="['/select-a-farm']">Switch farm</a></li>
      <li><a (click)="logout()">Logout</a></li>
    </ul>
  </nav>

  <!-- Overlay Content -->
  <div *ngIf="farmData" class="dashboard-content" [class.shifted]="menuOpen">
    <header class="dashboard-header">
      <div>
        <h1>{{ farmData.farmName }} Dashboard</h1>
        <p class="muted">Location: {{ farmData.location || '‚Äî' }} ‚Ä¢ Owner: {{ farmData.ownerName || '‚Äî' }}</p>
      </div>

      <div class="header-actions">
        <button class="btn-add-farm" (click)="goToAddFarm()">+ Add New Farm</button>
        <button class="btn" (click)="refreshAll()" title="Refresh">‚ü≥</button>
      </div>
    </header>

    <section class="dashboard-grid">

      <!-- LEFT COLUMN -->
      <div class="col-left">

        <!-- Stats overview -->
        <div class="card stats-card">
          <div class="card-row">
            <div class="stat-box" *ngFor="let s of statList">
              <div class="stat-value">{{ s.value ?? 0 }}</div>
              <div class="stat-label">{{ s.label }}</div>
            </div>
          </div>
        </div>

        <!-- Weather + AI -->
        <div class="card weather-card">
          <div class="card-header">
            <h3>Weather</h3>
            <span class="icon">üå§Ô∏è</span>
          </div>

          <div class="card-body weather-body">
            <div class="weather-main">
              <div class="temp">{{ weather.temperature }}</div>
              <div class="cond">{{ weather.condition }}</div>
            </div>

            <div class="weather-meta">
              <div>üíß {{ weather.humidity }}</div>
              <div>üåßÔ∏è {{ weather.rainfall }}</div>
            </div>

            <div class="ai-recommendation">
              <h4>üí° Watering Advice</h4>
              <ul>
                <li *ngFor="let insight of aiInsights">{{ insight }}</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Recent activity -->
        <div class="card activity-card">
          <div class="card-header">
            <h3>Recent Activity</h3>
            <a class="view-all" (click)="goToActivity()">View all</a>
          </div>

          <div class="card-body">
            <ul class="activity-list">
              <li *ngFor="let a of recentActivity">
                <div class="act-left">
                  <div class="act-time">{{ a.timestamp | date:'short' }}</div>
                  <div class="act-msg">{{ a.message }}</div>
                </div>
                <div class="act-right">
                  <button class="btn-link" *ngIf="a.link" (click)="navigateTo(a.link)">Open</button>
                </div>
              </li>

              <li *ngIf="recentActivity?.length === 0" class="empty">No recent activity.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="col-right">

        <!-- Quick actions -->
        <div class="card quick-actions">
          <h3>Quick Actions</h3>
          <div class="actions-grid">
            <button (click)="goToAddCrop()" class="action-btn">üå± Add Crop</button>
            <button (click)="goToAddLand()" class="action-btn">‚ûï Add Land</button>
            <button (click)="goToAddPest()" class="action-btn">ü™≤ Add Pest/Disease</button>
            <button (click)="goToReports()" class="action-btn">üìä Reports</button>
          </div>
        </div>

        <!-- Crop health chart -->
        <div class="card health-card">
          <div class="card-header">
            <h3>Crop Health</h3>
            <a class="view-all" (click)="goToCrops()">Details</a>
          </div>

          <div class="card-body chart-body">
            <canvas baseChart
                    [data]="healthChartData"
                    [type]="'doughnut'"
                    [options]="healthChartOptions">
            </canvas>

            <div class="health-legend">
              <div class="legend-item">
                <span class="dot good"></span>Good ({{ stats?.healthyCrops ?? 0 }})
              </div>
              <div class="legend-item">
                <span class="dot moderate"></span>Moderate ({{ stats?.moderateCrops ?? 0 }})
              </div>
              <div class="legend-item">
                <span class="dot critical"></span>Critical ({{ stats?.criticalCrops ?? 0 }})
              </div>
            </div>
          </div>
        </div>

        <!-- Sections grid -->
        <div class="card sections-card">
          <div class="card-header">
            <h3>Farm Sections</h3>
            <a class="view-all" (click)="goToSections()">View all</a>
          </div>

          <div class="card-body sections-grid">
            <div class="section-box" *ngFor="let land of lands">
              <h4>{{ land.sectionName }}</h4>
              <p>Soil: {{ land.soilType }}</p>
              <p>Size: {{ land.size }} {{ land.metrics }}</p>
              <p>Crop count: {{ land.cropCount ?? 0 }}</p>
              <div class="section-actions">
                <button (click)="viewLand(land.id)">View</button>
                <button (click)="goToAddCropForLand(land.id)">+ Crop</button>
              </div>
            </div>

            <div *ngIf="lands?.length === 0" class="empty">No sections yet.</div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <div *ngIf="!farmData" class="loading-placeholder">
    <div class="spinner-border" role="status"></div>
    <p>Loading dashboard‚Ä¶</p>
  </div>
</div>
